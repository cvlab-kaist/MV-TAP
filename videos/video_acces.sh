#!/bin/bash

# ==========================================================
# í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ mpeg4 ì½”ë± íŒŒì¼ì„ ì°¾ì•„ H.264ë¡œ ì¼ê´„ ë³€í™˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
# ==========================================================

for input_file in *.mp4; do
    # íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ë§Œì•½ *.mp4 íŒ¨í„´ì— ì¼ì¹˜í•˜ëŠ” íŒŒì¼ì´ ì—†ë‹¤ë©´ ê±´ë„ˆë›°ê¸°)
    if [ ! -f "$input_file" ]; then
        continue
    fi
    
    # ffmpeg -i ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ì½”ë± ì •ë³´ë¥¼ ì¶”ì¶œí•˜ê³ , ê·¸ ì •ë³´ì— "mpeg4"ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    # 2>&1ëŠ” ì—ëŸ¬ ì¶œë ¥(stderr)ì„ í‘œì¤€ ì¶œë ¥(stdout)ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜í•˜ì—¬ grepì´ ì½”ë± ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆê²Œ í•¨
    # -q ì˜µì…˜ì€ grepì´ ì°¾ì•˜ì„ ë•Œë§Œ 0ì„ ë°˜í™˜í•˜ê³  ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ì§€ ì•Šë„ë¡ í•¨
    if ffmpeg -i "$input_file" 2>&1 | grep -q "Video: mpeg4"; then
        
        # ----------------------------------------------------
        # 1. ë³€í™˜ ëŒ€ìƒ íŒŒì¼ í™•ì¸
        # ----------------------------------------------------
        
        # ì¶œë ¥ íŒŒì¼ ì´ë¦„ ì„¤ì • (íŒŒì¼ëª…ì—ì„œ í™•ì¥ì(.mp4)ë¥¼ ì œê±°í•˜ê³  _h264.mp4ë¥¼ ë¶™ì„)
        base_name="${input_file%.mp4}"
        output_file="./h264/${base_name}.mp4"

        echo "========================================================================"
        echo "ğŸ” [ë³€í™˜ ì‹œì‘] mpeg4 ì½”ë± íŒŒì¼ ê°ì§€: $input_file"
        echo "ğŸš€ [ì¶œë ¥ íŒŒì¼] $output_file"
        echo "========================================================================"

        # ----------------------------------------------------
        # 2. H.264 ì¸ì½”ë”© ì‹¤í–‰ (ì˜¤ë””ì˜¤ ì—†ìŒ (-an) ì˜µì…˜ í¬í•¨)
        #    libx264 ëŒ€ì‹  macOSì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ h264_videotoolbox ì‚¬ìš©
        # ----------------------------------------------------
        ffmpeg -i "$input_file" \
               -c:v h264_videotoolbox \
               -pix_fmt yuv420p \
               -an \
               "$output_file"
        
        # ----------------------------------------------------
        # 3. ê²°ê³¼ í”¼ë“œë°±
        # ----------------------------------------------------
        if [ $? -eq 0 ]; then
            echo "âœ… [ì„±ê³µ] $output_file ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        else
            echo "âŒ [ì˜¤ë¥˜] $input_file ë³€í™˜ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        fi
        
    else
        echo "ğŸ’¡ [ê±´ë„ˆë›°ê¸°] $input_file: mpeg4 ì½”ë±ì´ ì•„ë‹ˆê±°ë‚˜ ì´ë¯¸ h264ë¡œ ë³´ì…ë‹ˆë‹¤."
    fi
done

echo "========================================================================"
echo "ëª¨ë“  MP4 íŒŒì¼ ê²€ì‚¬ ì™„ë£Œ."